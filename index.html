<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Video-Publisher App · Tech-AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b0f14;--card:#131a22;--muted:#9fb0c3;--fg:#e7f0fc;--accent:#6ae3ff}
    *{box-sizing:border-box} body{margin:0;font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
    header{padding:20px 24px;border-bottom:1px solid #18212b}
    main{display:grid;gap:20px;grid-template-columns:1.2fr .8fr;max-width:1100px;margin:30px auto;padding:0 20px}
    .card, .aside{background:var(--card);border:1px solid #1b2632;border-radius:14px;padding:18px}
    h1{font-size:20px;margin:0} h2{margin:0 0 14px}
    .row{display:flex;align-items:center;gap:10px;margin:10px 0 14px}
    label{display:block;margin:12px 0 6px;color:var(--muted);font-size:13px}
    input[type=file], textarea, select{width:100%;background:#0e141b;border:1px solid #263243;border-radius:10px;color:var(--fg);padding:12px}
    textarea{min-height:96px;resize:vertical}
    .btn{appearance:none;border:1px solid #2b3950;background:#17202b;color:var(--fg);padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,#1fa2ff,#12d8fa,#a6ffcb);color:#03111a;border:0}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .status{font-size:13px;color:var(--muted)}
    .aside video{width:100%;max-height:360px;border-radius:10px;background:#0e141b}
    footer{max-width:1100px;margin:10px auto 40px;padding:0 20px;color:var(--muted);font-size:13px}
    a{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>
  <header>
    <h1>Video-Publisher App · Tech-AI</h1>
  </header>

  <main>
    <section class="card">
      <h2>Publish a video</h2>

      <div class="row">
        <button id="loginBtn" class="btn">Login with TikTok</button>
        <span id="status" class="status">Status: Not connected</span>
      </div>

      <label>Video file (mp4/mov)</label>
      <input id="file" type="file" accept="video/mp4,video/quicktime" />

      <label>Caption</label>
      <textarea id="caption" placeholder="Write a short caption…"></textarea>

      <label>Visibility</label>
      <select id="visibility">
        <option value="self" selected>Private (Sandbox)</option>
        <option value="public" disabled>Public (after approval)</option>
        <option value="friends" disabled>Friends</option>
      </select>

      <div class="row">
        <button id="prepareBtn" class="btn">Prepare upload</button>
        <button id="publishBtn" class="btn primary" disabled>Publish to TikTok</button>
      </div>
      <div id="msg" class="status"></div>
    </section>

    <aside class="aside">
      <h3>Preview</h3>
      <video id="preview" controls></video>
      <div style="margin-top:8px"><strong>Caption preview:</strong> <span id="capPrev">—</span></div>
    </aside>
  </main>

  <footer>
    <a href="/privacy.html">Privacy Policy</a> ·
    <a href="/terms.html">Terms of Service</a>
  </footer>

  <script>
    // --- Elements
    const loginBtn   = document.getElementById('loginBtn');
    const statusEl   = document.getElementById('status');
    const fileEl     = document.getElementById('file');
    const captionEl  = document.getElementById('caption');
    const visibility = document.getElementById('visibility');
    const prepareBtn = document.getElementById('prepareBtn');
    const publishBtn = document.getElementById('publishBtn');
    const msg        = document.getElementById('msg');
    const videoPrev  = document.getElementById('preview');
    const capPrev    = document.getElementById('capPrev');

    let PUBLISH_ID = null;

    // --- Login button (use your existing OAuth path; this works with your callback adding ?connected=1)
    loginBtn.addEventListener('click', () => {
      // If you already had a working authorize link, keep that path here:
      window.location.href = '/tiktok-login'
      });

    // --- Connected status indicator via ?connected=1 (your callback already does this)
    if (new URLSearchParams(location.search).get('connected') === '1') {
      localStorage.setItem('tiktok_connected', '1');
      if (history.replaceState) history.replaceState({}, '', location.pathname);
    }
    if (localStorage.getItem('tiktok_connected') === '1') {
      statusEl.textContent = 'Status: Connected';
    }

    // Live preview
    fileEl.addEventListener('change', () => {
      const f = fileEl.files?.[0];
      if (f) videoPrev.src = URL.createObjectURL(f);
    });
    captionEl.addEventListener('input', () => capPrev.textContent = captionEl.value);

    function setMessage(text){ msg.textContent = text; }

    // --- PREPARE (init + upload, but DO NOT publish)
    prepareBtn.addEventListener('click', async () => {
      if (!fileEl.files?.[0]) { alert('Please choose a video first.'); return; }
      setMessage('Preparing upload…');

      const fd = new FormData();
      fd.append('mode', 'prepare');
      fd.append('file', fileEl.files[0]);
      fd.append('caption', captionEl.value || '');
      fd.append('visibility', visibility.value);

      try {
        const res = await fetch('/api/publish', { method: 'POST', body: fd });
        const data = await res.json();
        if (data.ok && data.publish_id) {
          PUBLISH_ID = data.publish_id;
          publishBtn.disabled = false;
          setMessage('Upload prepared. Review the preview and click Publish.');
        } else {
          setMessage('Prepare failed: ' + (data.error || 'unknown'));
        }
      } catch (e) {
        setMessage('Prepare failed: ' + e.message);
      }
    });

    // --- PUBLISH (complete with publish_id)
    publishBtn.addEventListener('click', async () => {
      if (!PUBLISH_ID) { alert('Please click “Prepare upload” first.'); return; }
      setMessage('Publishing…');

      try {
        const res = await fetch('/api/publish', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({
            mode: 'publish',
            publish_id: PUBLISH_ID,
            caption: captionEl.value || '',
            visibility: visibility.value
          })
        });
        const data = await res.json();
        if (data.ok) {
          setMessage('Published on TikTok ✅ (Sandbox: private).');
        } else {
          setMessage('Publish failed: ' + (data.error || 'unknown'));
        }
      } catch (e) {
        setMessage('Publish failed: ' + e.message);
      }
    });
  </script>
</body>
</html>
