<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Video Publisher · Tech-AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b0f14;--card:#131a22;--fg:#e7f0fc;--muted:#8fa6ba;--accent:#47b3ff;--ok:#42ff9b;--bad:#ff5b5b}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    header{padding:22px;text-align:center;border-bottom:1px solid #18212b;background:#0f151d;font-weight:700}
    main{max-width:900px;margin:0 auto;padding:22px;display:grid;gap:22px}
    .card{background:var(--card);border:1px solid #1a2733;border-radius:14px;padding:22px}
    h2{margin:0 0 12px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .btn{border:0;border-radius:10px;padding:12px 16px;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--accent);color:#001018}
    .btn.ghost{background:#222a33;color:var(--fg)}
    .status{font-size:14px;margin-top:8px}
    .status .ok{color:var(--ok);font-weight:700}
    .status .bad{color:var(--bad);font-weight:700}
    .sub{color:var(--muted);font-size:13px;margin-top:4px}
    footer{text-align:center;color:var(--muted);font-size:13px;margin:8px 0 28px}
    a{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>
  <header>Video Publisher · Tech-AI</header>

  <main>
    <section class="card">
      <h2>Authentication</h2>
      <div class="row">
        <button id="loginBtn" class="btn primary">Login with TikTok</button>
        <button id="logoutBtn" class="btn ghost" style="display:none;">Logout</button>
      </div>
      <div id="status" class="status"><span class="bad">Not connected ❌</span></div>
      <div id="who" class="sub" style="display:none;"></div>
    </section>

    <section class="card">
      <h2>Next steps</h2>
      <ol class="sub">
        <li>Login above (Sandbox).</li>
        <li>After redirect back here you’ll see “Connected ✅”.</li>
        <li>(Optional) You’ll also see <em>Connected as @username</em> when Make passes it back.</li>
      </ol>
      <div class="sub">
        Need policies? → <a href="/privacy.html" target="_blank">Privacy</a> · <a href="/terms.html" target="_blank">Terms</a>
      </div>
    </section>
  </main>

  <footer>Tech-AI Demo</footer>

  <script>
    // === Configure these two ===
    const CLIENT_KEY   = "sbaw38yudfwzcabn86";   // ← put your Sandbox client key here
    const REDIRECT_URI = "https://auto-tiktok-uploader.vercel.app/api/tiktok-callback"; // ← your Make webhook URL (exactly as in TikTok Dev)

    const SCOPE = "user.info.basic,video.upload,video.publish";

    const qs = new URLSearchParams(location.search);
    const statusEl = document.getElementById("status");
    const whoEl = document.getElementById("who");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    function setConnectedUI(connected, username) {
      if (connected) {
        statusEl.innerHTML = `<span class="ok">Connected ✅</span>`;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        if (username) {
          whoEl.style.display = "block";
          whoEl.textContent = `Connected as @${username}`;
        } else {
          whoEl.style.display = "none";
          whoEl.textContent = "";
        }
      } else {
        statusEl.innerHTML = `<span class="bad">Not connected ❌</span>`;
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        whoEl.style.display = "none";
        whoEl.textContent = "";
      }
    }

    // initial state from localStorage
    const saved = localStorage.getItem("tiktok_connected") === "true";
    const savedUser = localStorage.getItem("tiktok_username") || "";
    setConnectedUI(saved, savedUser);

    // detect return from Make (we expect ?connected=1&username=foo optionally)
    if (qs.get("connected") === "1") {
      const uname = (qs.get("username") || qs.get("user") || "").trim();
      localStorage.setItem("tiktok_connected", "true");
      if (uname) localStorage.setItem("tiktok_username", uname);
      setConnectedUI(true, uname || localStorage.getItem("tiktok_username") || "");
      // clean query
      if (history.replaceState) history.replaceState({}, document.title, location.pathname);
    }

    loginBtn.addEventListener("click", () => {
      if (!CLIENT_KEY || CLIENT_KEY.includes("YOUR_CLIENT_KEY_HERE")) {
        alert("Please set CLIENT_KEY in index.html");
        return;
      }
      if (!REDIRECT_URI || REDIRECT_URI.includes("YOUR_REDIRECT_URI_HERE")) {
        alert("Please set REDIRECT_URI in index.html");
        return;
      }
      const state = Math.random().toString(36).slice(2);
      localStorage.setItem("oauth_state", state);
      const auth = new URL("https://www.tiktok.com/v2/auth/authorize/");
      auth.searchParams.set("client_key", CLIENT_KEY);
      auth.searchParams.set("scope", SCOPE);
      auth.searchParams.set("response_type", "code");
      auth.searchParams.set("redirect_uri", REDIRECT_URI);
      auth.searchParams.set("state", state);
      location.href = auth.toString();
    });

    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("tiktok_connected");
      localStorage.removeItem("tiktok_username");
      localStorage.removeItem("oauth_state");
      setConnectedUI(false, "");
    });
  </script>
</body>
</html>
