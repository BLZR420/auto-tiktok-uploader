<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Video-Publisher App</title>
  <style>
    :root { --bg:#0b0d10; --panel:#11141a; --muted:#a7b3c2; --acc:#7a5cff; --acc2:#27e1ff; }
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(140deg,#0b0d10 0%,#0f1320 100%);color:#e8ecf3}
    .wrap{max-width:980px;margin:40px auto;padding:24px}
    .hero{display:flex;gap:24px;align-items:center;flex-wrap:wrap;margin-bottom:24px}
    .badge{font-size:12px;letter-spacing:.1em;color:#9aa7b6;border:1px solid #263246;padding:6px 10px;border-radius:999px}
    h1{font-size:28px;margin:8px 0 4px} p.lead{color:#b8c2cf;margin:0 0 16px}
    .card{background:linear-gradient(180deg,#11141a 0%,#0f1218 100%);border:1px solid #1c2432;border-radius:14px;padding:18px}
    .grid{display:grid;gap:16px;grid-template-columns:1fr; }
    @media(min-width:800px){ .grid{grid-template-columns:1.3fr .7fr} }
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer}
    .btn-acc{background:linear-gradient(90deg,var(--acc),var(--acc2));color:#051017}
    .btn-ghost{background:#121722;border:1px solid #283349;color:#cfe6ff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    input[type="file"], input[type="text"], textarea{
      width:100%;background:#0f1420;border:1px solid #283349;border-radius:10px;color:#e8ecf3;padding:10px 12px
    }
    label{display:block;margin:10px 0 6px;color:#b4becb}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{padding:6px 10px;border-radius:999px;background:#0f1522;border:1px dashed #2a3650;color:#9fb0c8;font-size:12px}
    .ok{color:#7affad}.warn{color:#ffcf6e}.err{color:#ff7f9f}
    video{width:100%;border-radius:10px;border:1px solid #263246;background:#000;max-height:420px}
    .footer{margin-top:22px;color:#8ea2b8;font-size:12px}
    a{color:#9ecbff}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div class="badge">Video-Publisher App · Tech-AI</div>
    </div>

    <div class="grid">
      <!-- LEFT: Interaction -->
      <div class="card">
        <h1>Publish a video</h1>
        <p class="lead">Sign in, pick a file, add a caption, then publish. You stay in full control.</p>

        <div class="row" style="margin:12px 0 18px">
          <button id="btnLogin" class="btn btn-acc">Login with TikTok</button>
          <div id="authState" class="pill">Status: <span id="authStatus">Not connected</span></div>
        </div>

        <label for="file">Video file (mp4/mov)</label>
        <input id="file" type="file" accept="video/mp4,video/quicktime" />

        <label for="caption">Caption</label>
        <textarea id="caption" rows="3" placeholder="Write a short caption…"></textarea>

        <div class="row" style="margin-top:10px">
          <button id="btnPreview" class="btn btn-ghost">Preview</button>
          <button id="btnPublish" class="btn btn-acc" disabled>Publish to TikTok</button>
        </div>

        <div id="log" class="footer"></div>
      </div>

      <!-- RIGHT: Preview -->
      <div class="card">
        <h2 style="margin-top:0">Preview</h2>
        <video id="preview" controls muted playsinline></video>
        <div style="margin-top:8px" class="pill">Caption preview: <span id="capOut">—</span></div>
      </div>
    </div>

    <div class="footer" style="margin-top:20px">
      <a href="/privacy.html">Privacy Policy</a> · <a href="/terms.html">Terms of Service</a>
    </div>
  </div>

  <script>
    // ====== CONFIG – ersetzen ======
    const CLIENT_KEY     = "sbaw38yudfwzcabn86";
    const REDIRECT_URI   = "https://auto-tiktok-uploader.vercel.app/api/tiktok-callback";
    const SCOPE          = "user.info.basic,video.upload,video.publish";
    const PUBLISH_API    = "/api/publish"; // Serverless-Funktion, die an Make weiterleitet

    // ====== State detection (connected?) ======
    const urlParams = new URLSearchParams(location.search);
    const connected = urlParams.get("connected");
    const authStatus = document.getElementById('authStatus');
    if (connected === "1") authStatus.textContent = "Connected ✅";

    function log(msg, cls="") {
      const el = document.getElementById('log');
      el.innerHTML = `<span class="${cls}">${msg}</span>`;
    }

    // ====== UI handlers ======
    document.getElementById('btnLogin').onclick = () => {
      // generate simple state
      const state = Math.random().toString(36).slice(2);
      sessionStorage.setItem("oauth_state", state);
      const auth = new URL("https://www.tiktok.com/v2/auth/authorize/");
      auth.searchParams.set("client_key", CLIENT_KEY);
      auth.searchParams.set("scope", SCOPE);
      auth.searchParams.set("response_type", "code");
      auth.searchParams.set("redirect_uri", REDIRECT_URI);
      auth.searchParams.set("state", state);
      location.href = auth.toString();
    };

    const fileEl = document.getElementById('file');
    const capEl  = document.getElementById('caption');
    const capOut = document.getElementById('capOut');
    const preview= document.getElementById('preview');
    const btnPrev= document.getElementById('btnPreview');
    const btnPub = document.getElementById('btnPublish');

    btnPrev.onclick = () => {
      const f = fileEl.files?.[0];
      capOut.textContent = (capEl.value || "—").slice(0, 140);
      if (f) {
        preview.src = URL.createObjectURL(f);
        preview.play().catch(()=>{});
        btnPub.disabled = false;
      } else {
        log("Please choose a video file first.", "warn");
      }
    };

    btnPub.onclick = async () => {
      const f = fileEl.files?.[0];
      if (!f) return log("Please choose a video file.", "err");
      log("Uploading…");

      const fd = new FormData();
      fd.append("file", f);
      fd.append("caption", capEl.value || "");
      // Optional privacy level: PUBLIC | FRIENDS | PRIVATE
      fd.append("privacy_level", "PUBLIC");

      try {
        const res = await fetch(PUBLISH_API, { method: "POST", body: fd });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || "Upload failed");
        log("Uploaded successfully ✅", "ok");
      } catch (e) {
        log("Error: " + e.message, "err");
      }
    };
  </script>
</body>
</html>
